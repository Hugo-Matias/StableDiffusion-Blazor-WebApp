@page "/"
@inject DatabaseService DB
@inject AppState AppState
@implements IDisposable

<PageTitle>Blazor Diffusion</PageTitle>

@if (_projects == null)
{
    <LoadingSpinner />
}
else if (_projects.Count() == 0 && AppState.CurrentFolderId == 0)
{
    <MudContainer Class="d-flex flex-column align-items-center justify-content-center" Style="height: 50vh">
        <MudPaper Class="pa-10 d-flex flex-column align-items-center" MaxWidth="30vw" Elevation="5">
            <MudText Typo="Typo.h4" Class="mb-5" Style="text-align:center;">Create a new project to get started! 😎</MudText>
            <CreateProjectButton Color="Color.Info" Variant="Variant.Text" OnProjectCreated="async () => await RefreshProjects()">
                Lets Go
            </CreateProjectButton>
        </MudPaper>
    </MudContainer>
}
else
{
    <GallerySettings OnFilterImages="async () => await FilterImages(false)" OnResetFilters="async () => await FilterImages(true)" OnProjectDeleted="async () => await RefreshProjects()" />
    if (images != null && images.Images != null && images.Images.Count > 0)
    {
        <ImagesContainer Style="margin-bottom: 2rem;" Images="@images" OnPageSelected="async (page) => await LoadPage(page)" OnDeleteImage="async () => await LoadImages()" OnCoverChanged="async () => await InvokeAsync(StateHasChanged)" />
    }
    else if (images.Images.Count == 0)
    {
        <MudText Style="opacity: 0.4; text-align: center; margin-top: 10rem;" Typo="Typo.h5">Empty Project</MudText>
    }
    else
    {
        <MudStack Row Justify="Justify.Center" Style="margin-top: 10rem;">
        <MudProgressCircular Color="Color.Info" Indeterminate />
        </MudStack>
    }
}


@code {
    private ImagesDto images = new();
    private List<Project>? _projects;
    private int currentImgPage;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender) return;
        AppState.OnProjectChangeTask += HandleProjectChanged;
        AppState.OnStateHasChanged += StateHasChanged;
        await LoadProjects();
    }

    private async Task FilterImages(bool resetFilter)
    {
        currentImgPage = 1;
        AppState.IsGalleryFiltered = !resetFilter;
        await LoadImages();
    }

    private async Task LoadProjects()
    {
        _projects = await DB.GetProjects(AppState.CurrentFolderId);
        await AppState.GetProjects();
        currentImgPage = 1;
        await LoadImages();
    }

    private async Task LoadPage(int page)
    {
        currentImgPage = page;
        await LoadImages();
    }

    private async Task LoadImages()
    {
        if (images != null && images.Images != null) images.Images.Clear();
        if (AppState.IsGalleryFiltered) images = await DB.GetSortedImages(currentImgPage, AppState.CurrentProjectId, AppState.Settings.Gallery);
        else images = await DB.GetImages(currentImgPage, AppState.CurrentProjectId);
        await InvokeAsync(StateHasChanged);
    }

    private async Task RefreshProjects()
    {
        LoadProjects();
        await InvokeAsync(StateHasChanged);
    }

    private async Task HandleProjectChanged()
    {
        currentImgPage = 1;
        await LoadImages();
    }

    public void Dispose()
    {
        AppState.OnProjectChangeTask -= HandleProjectChanged;
        AppState.OnStateHasChanged -= StateHasChanged;
    }
}
