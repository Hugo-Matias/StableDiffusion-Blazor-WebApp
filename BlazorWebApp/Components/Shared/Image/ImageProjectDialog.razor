@inject DatabaseService DB

<MudDialog>
    <DialogContent>
        <MudSelect Label="Folder" Class="mb-4" Value=_currentFolderId ValueChanged=HandleFolderChanged T="int">
            <MudSelectItem Value=0>All</MudSelectItem>
            @foreach (var folder in _folders)
            {
                <MudSelectItem Value="@folder.Id">@folder.Name</MudSelectItem>
            }
        </MudSelect>
        <MudSelect Label="Project" Value=_currentProjectId ValueChanged=HandleProjectChanged T="int">
            @foreach (var project in _projects)
            {
                <MudSelectItem Value="@project.Id">@project.Name</MudSelectItem>
            }
        </MudSelect>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick=@(() => MudDialog.Close(DialogResult.Ok(Images))) Variant=Variant.Filled Color="Color.Success">Save</MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] public MudDialogInstance MudDialog { get; set; }
    [Parameter] public List<Image> Images { get; set; }
    private int _currentFolderId;
    private int _currentProjectId;
    private List<Folder> _folders;
    private List<Project> _projects;

    protected async override Task OnInitializedAsync()
    {
        _folders = await DB.GetFolders();
        _currentProjectId = Images[0].ProjectId;
        var imageProject = await DB.GetProject(_currentProjectId);
        _currentFolderId = imageProject.FolderId ?? 0;
        await GetProjects();
    }

    private async Task GetProjects() => _projects = await DB.GetProjects(_currentFolderId);

    private async Task HandleFolderChanged(int id)
    {
        _currentFolderId = id;
        await GetProjects();
    }

    private void HandleProjectChanged(int id)
    {
        _currentProjectId = id;
        foreach (var image in Images)
        {
            image.ProjectId = id;
        }
    }
}
