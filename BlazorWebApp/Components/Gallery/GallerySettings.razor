@inject AppState AppState
@inject DatabaseService DB
@inject IDialogService DialogService

<div>
    <MudPaper Class="p-3 mb-3">
        @if (AppState.Projects != null && AppState.Projects.Count > 0)
        {
            <MudStack Class="projects-container" Row>
                @foreach (var project in AppState.Projects)
                {
                    <ProjectCard ProjectId="project.Id" Name="@project.Name" OnSelected="HandleProjectSelected" OnDeleted="ShowDeleteProjectModal" OnEdited="ShowEditProjectModal"></ProjectCard>
                }
            </MudStack>
        }
    </MudPaper>
    <MudContainer MaxWidth="MaxWidth.Medium">
        <MudGrid>
            <MudItem xs="5">
                <MudStack>
                    <MudTextField T="string" @bind-Value="AppState.Settings.Gallery.SearchPrompt" Label="Prompt" HelperText="Search text contained in image's prompt." HelperTextOnFocus Variant="Variant.Text" />
                    <MudTextField Class="mt-n4" T="string" @bind-Value="AppState.Settings.Gallery.SearchNegativePrompt" Label="Negative Prompt" HelperText="Search text contained in image's negative prompt." HelperTextOnFocus Variant="Variant.Text" />
                </MudStack>
            </MudItem>
            <MudItem xs="3">
                <MudCheckBox Class="mt-4" Label="Favorites Only" @bind-Checked="AppState.Settings.Gallery.IsFavoritesOnly" Color="Color.Error" CheckedIcon="@Icons.Material.Filled.Favorite" UncheckedIcon="@Icons.Material.Filled.FavoriteBorder" />
                <MudStack Class="mt-2" Row>
                    <MudSelect Label="Order by" @bind-Value="AppState.Settings.Gallery.OrderBy">
                        @foreach (GalleryOrderBy order in Enum.GetValues(typeof(GalleryOrderBy)))
                        {
                            <MudSelectItem Value="order">@order</MudSelectItem>
                        }
                    </MudSelect>
                    <MudCheckBox Class="mt-2" Label="@(AppState.Settings.Gallery.OrderDescending ? "Desc" : "Asc")" CheckedIcon="@Icons.Material.Filled.ArrowDownward" UncheckedIcon="@Icons.Material.Filled.ArrowUpward" @bind-Checked="AppState.Settings.Gallery.OrderDescending" />
                </MudStack>
            </MudItem>
            <MudItem xs="4" Class="d-flex flex-column align-items-center">
                <MudText Typo="Typo.overline">Modes:</MudText>
                <MudChipSet SelectedChipsChanged="HandleModeSelection" Class="" Filter MultiSelection>
                    <MudChip Text="Txt2Img" Variant="Variant.Text" Color="Color.Primary" Default="AppState.Settings.Gallery.IsModeTxt2Img"/>
                    <MudChip Text="Img2Img" Variant="Variant.Text" Color="Color.Primary" Default="AppState.Settings.Gallery.IsModeImg2Img"/>
                    <MudChip Text="Upscale" Variant="Variant.Text" Color="Color.Primary" Default="AppState.Settings.Gallery.IsModeUpscale"/>
                </MudChipSet>
                <MudButtonGroup Class="mt-5" Variant="Variant.Outlined" Color="Color.Primary" OverrideStyles=false>
                    <MudButton OnClick="async () => await OnFilterImages.InvokeAsync()" Variant="Variant.Outlined" Color="Color.Warning">Filter</MudButton>
                    <MudButton OnClick="async () => await OnResetFilters.InvokeAsync()" Variant="Variant.Outlined" Color="Color.Error">Reset</MudButton>
                </MudButtonGroup>
            </MudItem>
        </MudGrid>
    </MudContainer>
</div>

@code {
    [Parameter]
    public EventCallback OnFilterImages { get; set; }
    [Parameter]
    public EventCallback OnResetFilters { get; set; }

    DialogOptions _dialogOptions = new DialogOptions() { CloseButton = true, MaxWidth = MaxWidth.Small };

    private async Task HandleProjectSelected(int projectId)
    {
        await AppState.SetCurrentProject(projectId);
        StateHasChanged();
    }

    private void HandleModeSelection(MudChip[] chips)
    {
        AppState.Settings.Gallery.IsModeTxt2Img = chips.Any(c => c.Text == "Txt2Img");
        AppState.Settings.Gallery.IsModeImg2Img = chips.Any(c => c.Text == "Img2Img");
        AppState.Settings.Gallery.IsModeUpscale = chips.Any(c => c.Text == "Upscale");
    }

    private async Task ShowDeleteProjectModal(int projectId)
    {
        var parameters = new DialogParameters();
        parameters.Add("OkButtonText", "Yes");
        parameters.Add("CancelButtonText", "No");
        parameters.Add("OkButtonColor", Color.Error);
        parameters.Add("Content", new MarkupString(@"<span class='lead'>Are you sure you want to <strong class='text-danger'>delete</strong> this project?<br /></span><small>This action is irreversible!</small>"));
        var dialog = await DialogService.ShowAsync<ConfirmationDialogModal>("Delete Project", parameters, _dialogOptions);
        var result = await dialog.Result;
        if (!result.Cancelled) await DeleteProject(projectId);
    }

    private async Task DeleteProject(int id)
    {
        var project = await DB.DeleteProject(id);
        await AppState.GetProjects();
        if (project != null)
            await AppState.SetCurrentProject(project.Id);
        else
            await AppState.SetCurrentProject(0);
        await InvokeAsync(StateHasChanged);
    }

    private async Task ShowEditProjectModal(int projectId)
    {
        var project = AppState.Projects.FirstOrDefault(p => p.Id == projectId);
        var param = new DialogParameters();
        param.Add("Project", project);
        var dialog = await DialogService.ShowAsync<EditProjectModal>("Edit", param, _dialogOptions);
        var result = await dialog.Result;
        if (!result.Cancelled) await EditProject((Project)result.Data);
    }

    private async Task EditProject(Project project)
    {
        var updates = new Project() { Name = project.Name };
        if (project.Folder != null) updates.FolderId = project.Folder.Id;
        await DB.UpdateProject(project.Id, updates);
        // Re-sets current project to refresh the relevant ui components
        await AppState.SetCurrentProject(AppState.CurrentProjectId);
        await InvokeAsync(StateHasChanged);
    }
}
